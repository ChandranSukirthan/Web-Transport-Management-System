<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QuickMove ‚Äî Driver Tracking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    @import url("https://rsms.me/inter/inter.css");
    #map { height: 520px; border-radius: 12px; overflow: hidden; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .status-requested { background:#64748b; }
    .status-ontrip { background:#22c55e; }
    .status-error { background:#ef4444; }
    .you-icon { width: 26px; height: 26px; background:#22c55e; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
    .rider-icon { width: 26px; height: 26px; background:#2563eb; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
  </style>
</head>
<body class="bg-white text-slate-800">
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/ride-booking.html" class="text-xl font-bold text-orange-600">QuickMove</a>
      <a href="/ride-booking.html" class="text-sm font-medium text-orange-600 hover:text-orange-700">Book a ride</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="mb-5">
      <h1 class="text-2xl md:text-3xl font-bold text-orange-600">Driver Tracking (MQTT)</h1>
      <div class="text-slate-500 text-sm">Subscribe to rider topic; publish your location</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <div class="lg:col-span-2">
        <div class="rounded-xl border border-slate-200 shadow-sm">
          <div class="p-3">
            <div id="map"></div>
          </div>
        </div>
      </div>
      <aside class="space-y-4">
        <section class="rounded-xl border border-slate-200 shadow-sm">
          <div class="p-4">
            <h2 class="text-lg font-semibold mb-3">MQTT connection</h2>
            <div class="flex items-center mb-2 text-sm">
              <span id="connDot" class="status-dot status-requested"></span>
              <span id="connText" class="text-slate-600">Connecting‚Ä¶</span>
            </div>
            <div class="mb-2 text-xs text-slate-500">Rider topic</div>
            <div id="topicRider" class="mb-3 font-mono text-sm break-all">‚Äî</div>
            <div class="mb-2 text-xs text-slate-500">Driver topic</div>
            <div id="topicDriver" class="mb-3 font-mono text-sm break-all">‚Äî</div>
            <div class="mb-3">
              <div class="text-slate-500 text-sm">Last rider location</div>
              <div id="lastRiderText" class="text-xl font-semibold text-slate-800">‚Äî</div>
            </div>
            <label class="flex items-center gap-2 mb-3 select-none">
              <input class="h-4 w-4 rounded border-slate-300 text-orange-600 focus:ring-orange-500" type="checkbox" id="shareSwitch" />
              <span class="text-sm">Share my location to rider</span>
            </label>
            <button id="endTripBtn" class="w-full px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white disabled:opacity-60 disabled:cursor-not-allowed" disabled>End Trip (driver only)</button>
            <!-- Button shown after trip is successfully completed to proceed to payment -->
            <button id="gotoPaymentBtn" style="display:none;" class="w-full mt-2 px-4 py-2 rounded bg-amber-600 hover:bg-amber-700 text-white">Go to Payment</button>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    (function(){
      const MQTT_URL = window.MQTT_URL || 'wss://355bf2c4e74f4d59a6d6fd43c1b98ab1.s1.eu.hivemq.cloud:8884/mqtt';
      const MQTT_USERNAME = window.MQTT_USERNAME || 'rdwij';
      const MQTT_PASSWORD = window.MQTT_PASSWORD || 'Password1';
      const RIDER_TOPIC_TEMPLATE = window.MQTT_RIDER_TOPIC || 'rides/{id}/rider';
      const DRIVER_TOPIC_TEMPLATE = window.MQTT_DRIVER_TOPIC || 'rides/{id}/driver';

      function getQuery(){ const p = new URLSearchParams(location.search); return Object.fromEntries(p.entries()); }
      const qp = getQuery();
      const qpRideId = qp.rideId && !Number.isNaN(Number(qp.rideId)) ? String(qp.rideId) : null;
      const qpDriverIdNum = qp.driverId ? Number(qp.driverId) : null;
      const driverUserIdQP = qp.driverUserId || null;
      const riderUserIdQP = qp.riderUserId || qp.userId || null;
      const autoShare = !!(qp.driverId || driverUserIdQP);

      const connDot = document.getElementById('connDot');
      const connText = document.getElementById('connText');
      const topicRiderEl = document.getElementById('topicRider');
      const topicDriverEl = document.getElementById('topicDriver');
      const lastRiderText = document.getElementById('lastRiderText');
      const shareSwitch = document.getElementById('shareSwitch');
      const endTripBtn = document.getElementById('endTripBtn');
      const gotoPaymentBtn = document.getElementById('gotoPaymentBtn');

      let rideIdUsed = qpRideId;
      let driverIdNumeric = qpDriverIdNum;
      let driverUserIdUsed = driverUserIdQP;
      let riderUserIdUsed = riderUserIdQP;
      let riderTopic = '‚Äî';
      let driverTopic = '‚Äî';
      let currentRideStatus = null;

      function setConn(status, text){
        connText.textContent = text;
        connDot.className = 'status-dot ' + (status==='ok' ? 'status-ontrip' : status==='err' ? 'status-error' : 'status-requested');
      }

      async function fetchJSON(url, opts){ const res = await fetch(url, opts); if(!res.ok) throw new Error(await res.text()); return res.json(); }
      async function resolveContext(){
        if (rideIdUsed) {
          const ride = await fetchJSON(`/api/rides/${encodeURIComponent(rideIdUsed)}`);
          riderUserIdUsed = ride.userId;
          driverUserIdUsed = ride.driverId; if(!driverUserIdUsed) throw new Error('No driver assigned');
        } else if (driverUserIdUsed) {
          const ride = await fetchJSON(`/api/rides/active?driverUserId=${encodeURIComponent(driverUserIdUsed)}`);
          rideIdUsed = String(ride.id);
          riderUserIdUsed = ride.userId;
        } else if (riderUserIdUsed) {
          const ride = await fetchJSON(`/api/rides/active?riderUserId=${encodeURIComponent(riderUserIdUsed)}`);
          rideIdUsed = String(ride.id);
          driverUserIdUsed = ride.driverId; if(!driverUserIdUsed) throw new Error('No driver assigned');
        } else {
          throw new Error('Provide rideId or driverUserId or riderUserId');
        }
        if (!driverIdNumeric) {
          const driver = await fetchJSON(`/api/drivers/user/${encodeURIComponent(driverUserIdUsed)}`);
          driverIdNumeric = Number(driver.id);
        }
        riderTopic = (RIDER_TOPIC_TEMPLATE||'').replace('{id}', rideIdUsed);
        driverTopic = (DRIVER_TOPIC_TEMPLATE||'').replace('{id}', rideIdUsed);
        topicRiderEl.textContent = riderTopic;
        topicDriverEl.textContent = driverTopic;
        endTripBtn.disabled = !driverIdNumeric;
      }

      async function fetchRide(){ if(!rideIdUsed) return null; try{ return await fetchJSON(`/api/rides/${encodeURIComponent(rideIdUsed)}`); }catch(_){ return null; } }
      async function startRideIfNeeded(){
        const ride = await fetchRide(); if(!ride) throw new Error('Ride not found');
        currentRideStatus = (ride.status||'').toUpperCase();
        if(currentRideStatus === 'PENDING') throw new Error('Ride not accepted yet');
        if(currentRideStatus === 'ACCEPTED'){
          const r = await fetch(`/api/drivers/${encodeURIComponent(driverIdNumeric)}/rides/${encodeURIComponent(rideIdUsed)}/start`, { method:'POST' });
          if(!r.ok){ throw new Error('Unable to start ride'); }
          currentRideStatus = 'IN_PROGRESS';
        }
        return true;
      }
      async function completeRide(){
        const r = await fetch(`/api/drivers/${encodeURIComponent(driverIdNumeric)}/rides/${encodeURIComponent(rideIdUsed)}/complete`, { method:'POST' });
        if(!r.ok){ throw new Error('Unable to complete ride'); }
        currentRideStatus = 'COMPLETED';
      }
      async function endTrackingSession(){
        try { await fetch(`/api/tracking-sessions/ride/${encodeURIComponent(rideIdUsed)}/end?driverId=${encodeURIComponent(driverIdNumeric)}`, { method:'POST' }); }
        catch(_){ /* best-effort */ }
      }
      // After trip completes: stop sharing and show a button to proceed to payment
      async function finishUI(){
        stopShare(); shareSwitch.checked=false; endTripBtn.disabled=true; setConn('ok','Trip ended');
        // Try to fetch ride to determine the fare
        let amount = 0;
        try{
          const ride = await fetchRide();
          amount = (ride && (ride.fare || ride.amount)) || 0;
        }catch(_){ /* ignore */ }
        // Show and enable the payment button with amount if available
        if(gotoPaymentBtn){
          // Always make the button visible and enabled so driver can navigate to payment
          gotoPaymentBtn.style.display = 'block';
          gotoPaymentBtn.disabled = false;
          try{ gotoPaymentBtn.textContent = `Go to Payment${amount ? ' ‚Äî $' + Number(amount).toFixed(2): ''}`; }catch(_){ gotoPaymentBtn.textContent = 'Go to Payment'; }
        }
      }

      async function fetchAndShowRide(){
        try{
          const ride = await fetchRide();
          if(ride){
            const st=(ride.status||'').toUpperCase();
            currentRideStatus=st;
            // Enable only if actionable; otherwise disable
            endTripBtn.disabled = !driverIdNumeric || (st!=='ACCEPTED' && st!=='IN_PROGRESS');
            if(st==='COMPLETED' || st==='CANCELLED'){ setConn('ok', st==='COMPLETED' ? 'Trip completed' : 'Trip cancelled'); }
          }
        } catch(_){ endTripBtn.disabled = !driverIdNumeric; }
      }

      // Map
      let map, youMarker, riderMarker;
      function initMap(){ map = L.map('map', { scrollWheelZoom:true }); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map); map.setView([20,0],2); }
      function setYouMarker(pos, ts){
        if(!pos) return; const latlng=[pos.lat,pos.lng]; const html=`<div><strong>You (Driver)</strong><br>${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}${ts? `<br>${new Date(ts).toLocaleTimeString()}`:''}</div>`;
        if(youMarker){ youMarker.setLatLng(latlng); const tt=youMarker.getTooltip(); if(tt) tt.setContent(html); else youMarker.bindTooltip(html,{direction:'top'}); }
        else { const icon=L.divIcon({className:'', html:'<div class="you-icon">üöó</div>', iconSize:[26,26], iconAnchor:[13,13]}); youMarker=L.marker(latlng,{icon}).addTo(map); youMarker.bindTooltip(html,{direction:'top'}); }
        try{ map.setView(latlng, Math.max(13, map.getZoom())); }catch(_){ }
      }
      function setRiderMarker(pos, ts){
        if(!pos) return; const latlng=[pos.lat,pos.lng]; const html=`<div><strong>Rider</strong><br>${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}${ts? `<br>${new Date(ts).toLocaleTimeString()}`:''}</div>`;
        if(riderMarker){ riderMarker.setLatLng(latlng); const tt=riderMarker.getTooltip(); if(tt) tt.setContent(html); else riderMarker.bindTooltip(html,{direction:'top'}); }
        else { const icon=L.divIcon({className:'', html:'<div class="rider-icon">üßë‚Äçü¶∞</div>', iconSize:[26,26], iconAnchor:[13,13]}); riderMarker=L.marker(latlng,{icon}).addTo(map); riderMarker.bindTooltip(html,{direction:'top'}); }
      }

      initMap();
      setConn('wait','Resolving ride‚Ä¶');

      const clientId = `driver-ui-${Math.random().toString(16).slice(2,8)}`;
      const options = { clientId, clean:true, reconnectPeriod:2000, keepalive:60, username:MQTT_USERNAME, password:MQTT_PASSWORD };
      let client; try{ client = mqtt.connect(MQTT_URL, options); }catch(e){ setConn('err','Connect error'); }

      let geoWatchId=null;
      function stopShare(){ if(geoWatchId!=null){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; } }
      async function startShare(){
        try{ if(!rideIdUsed || !driverIdNumeric){ await resolveContext(); } }
        catch(e){ alert('Cannot start sharing: ' + (e.message||e)); shareSwitch.checked=false; return; }
        if(!('geolocation' in navigator)){ alert('Geolocation not supported'); shareSwitch.checked=false; return; }
        try{ await fetch('/api/tracking-sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rideId:Number(rideIdUsed), driverId:driverIdNumeric, riderUserId:riderUserIdUsed, createdBy:'driver' }) }); }catch(_){ }
        geoWatchId = navigator.geolocation.watchPosition((pos)=>{
          const lat=pos.coords.latitude, lng=pos.coords.longitude, ts=Date.now();
          try{ client && driverTopic && client.publish(driverTopic, JSON.stringify({ lat,lng,ts,role:'driver', rideId: rideIdUsed }), { qos:0, retain:false }); }catch(_){ }
          setYouMarker({ lat, lng }, ts);
        }, (err)=>{ alert('Unable to access your location: ' + (err?.message||'Permission denied or unavailable')); shareSwitch.checked=false; stopShare(); }, { enableHighAccuracy:true, maximumAge:10000, timeout:10000 });
      }

      shareSwitch.addEventListener('change', function(){ if(shareSwitch.checked) startShare(); else stopShare(); });

      endTripBtn.addEventListener('click', async function(){
        try{ if(!rideIdUsed || !driverIdNumeric){ await resolveContext(); } }
        catch(e){ alert('Cannot end trip: ' + (e.message||e)); return; }
        endTripBtn.disabled = true;
        try{
          await startRideIfNeeded();
          await completeRide();
          await endTrackingSession();
          await finishUI();
        }catch(e){
          endTripBtn.disabled = false;
          alert('End trip failed: ' + (e.message||e));
        }
      });

      // Payment button handler: navigate to payment page with rideId and amount
      if(gotoPaymentBtn){
        gotoPaymentBtn.addEventListener('click', async function(){
          // Ensure we have a ride and amount
          let ride = null;
          try{ ride = await fetchRide(); }catch(_){ }
          const id = rideIdUsed || (ride && String(ride.id));
          const amount = (ride && (ride.fare || ride.amount)) || '';
          if(!id){
            // try to resolve context and retry
            try{ await resolveContext(); }
            catch(e){ alert('Ride ID not available: ' + (e.message||e)); return; }
          }
          const q = `?rideId=${encodeURIComponent(id)}&amount=${encodeURIComponent(Number(amount||0).toFixed(2))}`;
          // Use full path so relative navigation is clear
          window.location.href = window.location.origin + '/payment.html' + q;
        });
      }

      if(client){
        client.on('connect', async ()=>{
          try{
            await resolveContext();
            setConn('ok','Connected');
            if(riderTopic){ try{ client.subscribe(riderTopic, { qos:0 }); }catch(_){ } }
            if(autoShare){ shareSwitch.checked=true; startShare(); }
            fetchAndShowRide();
          }catch(e){ setConn('err','Resolve failed'); alert('Invalid IDs: ' + (e.message||e)); }
        });
        client.on('reconnect', ()=> setConn('wait','Reconnecting‚Ä¶'));
        client.on('close', ()=> setConn('wait','Disconnected'));
        client.on('error', ()=> setConn('err','Connection error'));
        client.on('message', (topic, message)=>{
          if(topic !== riderTopic) return;
          try{ const data = JSON.parse(message.toString()); if(typeof data.lat!=='number'||typeof data.lng!=='number') return; lastRiderText.textContent = `${data.lat.toFixed(5)}, ${data.lng.toFixed(5)}${data.ts? ' ‚Ä¢ ' + new Date(data.ts).toLocaleTimeString():''}`; setRiderMarker({ lat:data.lat, lng:data.lng }, data.ts); }catch(_){ }
        });
      }

      // Poll button state every 5s to reflect backend changes
      const endBtnPoll = setInterval(fetchAndShowRide, 5000);

      window.addEventListener('beforeunload', ()=>{ try{ clearInterval(endBtnPoll); stopShare(); client && client.end(true); }catch(_){ } });
    })();
  </script>
</body>
</html>
