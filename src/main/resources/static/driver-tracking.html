<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickMove — Driver Tracking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 520px; border-radius: 12px; overflow: hidden; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .status-ontrip { background:#22c55e; }
    .status-error { background:#ef4444; }
    .you-icon { width: 26px; height: 26px; background:#22c55e; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
    .rider-icon { width: 26px; height: 26px; background:#2563eb; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
  </style>
</head>
<body class="bg-white text-slate-800">
<header class="border-b border-slate-200 bg-white/80 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="/" class="text-xl font-bold text-orange-600">QuickMove</a>
    <div>Ride in Progress</div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <h1 class="text-2xl md:text-3xl font-bold text-orange-600 mb-2">Driver Tracking</h1>
  <p class="text-slate-500 text-sm mb-6">Live location sharing with rider</p>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <div id="map" class="border border-slate-200 shadow-lg"></div>
    </div>

    <aside class="space-y-5">
      <section class="bg-white rounded-xl border border-slate-200 shadow p-5">
        <h2 class="text-lg font-semibold mb-4">Connection Status</h2>
        <div class="flex items-center gap-2 text-sm">
          <span id="connDot" class="status-dot status-error"></span>
          <span id="connText">Connecting…</span>
        </div>

        <div class="mt-4 space-y-3 text-sm">
          <div><strong>Rider Topic:</strong> <span id="topicRider" class="font-mono text-xs">—</span></div>
          <div><strong>Driver Topic:</strong> <span id="topicDriver" class="font-mono text-xs">—</span></div>
          <div><strong>Last Rider Location:</strong> <div id="lastRiderText" class="font-medium">—</div></div>
        </div>

        <label class="flex items-center gap-3 mt-5 cursor-pointer">
          <input type="checkbox" id="shareSwitch" class="w-5 h-5 text-orange-600" checked />
          <span>Share my location with rider</span>
        </label>

        <button id="endTripBtn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">
          End Trip (Driver Only)
        </button>

        <!-- Payment Button - Hidden until trip ends -->
        <button id="gotoPaymentBtn" style="display:none;" class="mt-3 w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition">
          Go to Payment — $<span id="fareAmount">0.00</span>
        </button>
      </section>
    </aside>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const qp = Object.fromEntries(new URLSearchParams(location.search));
  const rideId = qp.rideId;
  const driverId = qp.driverId ? Number(qp.driverId) : null;

  if (!rideId || !driverId) {
    alert("Missing rideId or driverId");
    throw new Error("Invalid access");
  }

  const MQTT_URL = 'wss://355bf2c4e74f4d59a6d6fd43c1b98ab1.s1.eu.hivemq.cloud:8884/mqtt';
  const MQTT_USER = 'rdwij';
  const MQTT_PASS = 'Password1';

  const riderTopic = `rides/${rideId}/rider`;
  const driverTopic = `rides/${rideId}/driver`;

  document.getElementById('topicRider').textContent = riderTopic;
  document.getElementById('topicDriver').textContent = driverTopic;

  let map, youMarker, riderMarker;
  function initMap() {
    map = L.map('map').setView([6.9271, 79.8612], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  }

  function updateMarker(marker, lat, lng, iconHtml, tooltip) {
    const latlng = [lat, lng];
    if (marker) marker.setLatLng(latlng);
    else {
      const icon = L.divIcon({ html: iconHtml, iconSize: [26,26], className: '' });
      marker = L.marker(latlng, { icon }).addTo(map).bindTooltip(tooltip, { permanent: false });
    }
    marker.setTooltipContent(tooltip);
    return marker;
  }

  // MQTT Setup
  const client = mqtt.connect(MQTT_URL, {
    username: MQTT_USER,
    password: MQTT_PASS,
    clientId: `driver_${driverId}_${Date.now()}`
  });

  client.on('connect', () => {
    document.getElementById('connDot').className = 'status-dot status-ontrip';
    document.getElementById('connText').textContent = 'Connected & Sharing';
    client.subscribe(riderTopic);
  });

  client.on('message', (topic, msg) => {
    if (topic !== riderTopic) return;
    try {
      const data = JSON.parse(msg.toString());
      if (data.lat && data.lng) {
        document.getElementById('lastRiderText').textContent =
                `${data.lat.toFixed(5)}, ${data.lng.toFixed(5)}`;
        riderMarker = updateMarker(riderMarker, data.lat, data.lng,
                '<div class="rider-icon">Person</div>',
                `<strong>Rider</strong><br>${new Date(data.ts || Date.now()).toLocaleTimeString()}`
        );
        map.setView([data.lat, data.lng], 16);
      }
    } catch (e) {}
  });

  // Share Driver Location
  let watchId = null;
  function startSharing() {
    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;
      const payload = JSON.stringify({ lat, lng, ts: Date.now(), role: 'driver' });
      client.publish(driverTopic, payload);
      youMarker = updateMarker(youMarker, lat, lng,
              '<div class="you-icon">Car</div>',
              `<strong>You (Driver)</strong><br>${new Date().toLocaleTimeString()}`
      );
      map.setView([lat, lng], 16);
    }, null, { enableHighAccuracy: true });
  }

  document.getElementById('shareSwitch').addEventListener('change', e => {
    if (e.target.checked) startSharing();
    else if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  });

  // End Trip → Complete Ride → Show Payment Button
  document.getElementById('endTripBtn').addEventListener('click', async () => {
    if (!confirm("End this trip?")) return;

    document.getElementById('endTripBtn').disabled = true;
    document.getElementById('endTripBtn').textContent = "Completing...";

    try {
      // 1. Start ride if not started
      await fetch(`/api/drivers/${driverId}/rides/${rideId}/start`, { method: 'POST' });

      // 2. Complete ride
      const completeRes = await fetch(`/api/drivers/${driverId}/rides/${rideId}/complete`, { method: 'POST' });
      if (!completeRes.ok) throw new Error("Failed to complete ride");

      const ride = await (await fetch(`/api/rides/${rideId}`)).json();
      const fare = (ride.fare || ride.amount || 0).toFixed(2);

      // Success: Stop sharing + show payment
      if (watchId) navigator.geolocation.clearWatch(watchId);
      document.getElementById('shareSwitch').checked = false;
      document.getElementById('connText').textContent = 'Trip Completed';
      document.getElementById('endTripBtn').style.display = 'none';

      const payBtn = document.getElementById('gotoPaymentBtn');
      document.getElementById('fareAmount').textContent = fare;
      payBtn.style.display = 'block';

      payBtn.onclick = () => {
        window.location.href = `/payment.html?rideId=${rideId}&amount=${fare}`;
      };

    } catch (err) {
      alert("Error ending trip: " + err.message);
      document.getElementById('endTripBtn').disabled = false;
      document.getElementById('endTripBtn').textContent = "End Trip (Driver Only)";
    }
  });

  // Init
  initMap();
  startSharing(); // Auto-share on load
</script>
</body>
</html>