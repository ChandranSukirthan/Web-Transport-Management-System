<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - QuickMove</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-primary { background-color: var(--primary); }
        .hover\:bg-primary-dark:hover { background-color: var(--primary-dark); }
        .text-primary { color: var(--primary); }
        .bg-secondary { background-color: var(--muted); }
    </style>
</head>
<body class="p-8 bg-gray-50">

<!-- Home button: redirects to index (top-right) -->
<a href="/index.html" class="home-btn">Home</a>

<div class="container">
  <div class="card">
    <div class="header">
      <div class="logo">QM</div>
      <div>
        <div class="title">Create an account</div>
        <div class="subtitle small">Sign up as a customer or register as a driver</div>
      </div>
    </div>
    <h1 class="text-2xl font-bold mb-6">&nbsp;</h1>

    <div class="mb-6">
        <label class="inline-flex items-center">
            <input type="radio" name="role" value="CUSTOMER" checked class="mr-2">
            <span>Customer</span>
        </label>
        <label class="inline-flex items-center ml-8">
            <input type="radio" name="role" value="DRIVER" class="mr-2">
            <span>Driver</span>
        </label>
    </div>

    <div class="space-y-4">
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
            <input id="name" type="text" placeholder="Full name" class="input focus-ring">
        </div>
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input id="email" type="email" placeholder="you@example.com" class="input focus-ring">
        </div>
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input id="password" type="password" placeholder="••••••••" class="input focus-ring">
        </div>
    </div>

    <div id="customerActions" class="mt-6">
        <button id="customerRegisterBtn" class="primary-btn">Register as Customer</button>
    </div>

    <div id="driverActions" class="mt-6 hidden">
        <button id="continueToDriverBtn" class="primary-btn" style="background:var(--muted);">Continue to Driver Details →</button>
    </div>

    <div id="message" class="mt-6 text-center"></div>

    <div class="mt-6 text-center text-sm text-gray-600">
        Already have an account? <a href="/login" class="text-primary font-medium">Login</a>
    </div>
  </div>
</div>

<script>
    const roleRadios = document.querySelectorAll('input[name="role"]');
    const customerActions = document.getElementById('customerActions');
    const driverActions = document.getElementById('driverActions');
    const customerBtn = document.getElementById('customerRegisterBtn');
    const continueBtn = document.getElementById('continueToDriverBtn');
    const message = document.getElementById('message');

    function updateRoleView() {
        const isDriver = document.querySelector('input[name="role"]:checked').value === 'DRIVER';
        customerActions.classList.toggle('hidden', isDriver);
        driverActions.classList.toggle('hidden', !isDriver);
    }

    function areFieldsFilled() {
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        return name && email && password;
    }

    // Role switch
    roleRadios.forEach(radio => radio.addEventListener('change', updateRoleView));

    // Customer Registration
    customerBtn.addEventListener('click', async () => {
        if (!areFieldsFilled()) {
            message.innerHTML = '<p class="text-red-600">Please fill all fields</p>';
            return;
        }

        const payload = {
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value,
            role: "CUSTOMER"
        };

        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (!res.ok) {
                message.innerHTML = `<p class="text-red-600">Error: ${data.error || 'Registration failed'}</p>`;
            } else {
                message.innerHTML = '<p class="text-green-600 font-medium">Successfully registered! Redirecting...</p>';
                setTimeout(() => window.location.href = '/', 1500);
            }
        } catch (err) {
            message.innerHTML = '<p class="text-red-600">Network error. Try again.</p>';
        }
    });

    // Continue to Driver Details
    continueBtn.addEventListener('click', () => {
        if (!areFieldsFilled()) {
            message.innerHTML = '<p class="text-red-600">Please fill name, email, and password first</p>';
            return;
        }

        const data = {
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value
        };

        // Store securely in sessionStorage
        sessionStorage.setItem('pendingDriver', JSON.stringify(data));
        window.location.href = '/driver-details.html';
    });

    // Initial setup
    updateRoleView();
</script>
</body>
</html>