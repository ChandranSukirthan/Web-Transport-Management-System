<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickMove â€” Ride Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    #map { height: 420px; }
    .disabled { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body class="bg-white text-slate-800">

<!-- Home button (top-right) -->
<a href="/index.html" style="position:fixed;top:12px;right:12px;background:rgba(255,255,255,0.95);color:#ff6b35;padding:8px 12px;border-radius:10px;font-weight:700;text-decoration:none;box-shadow:0 6px 18px rgba(15,23,42,0.12);z-index:9999;">Home</a>

  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/ride-booking.html" class="text-xl font-bold text-orange-600">QuickMove</a>
      <nav class="text-sm text-slate-600">Book a ride fast and easy</nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-5 text-orange-600 text-center">Ride Booking</h1>

    <!-- Map -->
    <div id="map" class="rounded-xl border border-slate-200 shadow-sm mb-4"></div>

    <!-- Summary -->
    <div class="rounded-xl border border-slate-200 p-4 shadow-sm mb-5">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
        <p>Pickup: <span id="pickupLabel" class="font-semibold text-orange-600">Not selected</span></p>
        <p>Dropoff: <span id="dropoffLabel" class="font-semibold text-orange-600">Not selected</span></p>
        <p>Distance: <span id="distance" class="font-semibold text-orange-600">-</span> km</p>
        <p>Time: <span id="duration" class="font-semibold text-orange-600">0.0</span> mins</p>
      </div>
    </div>

    <!-- Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
      <div>
        <label for="pickupInput" class="block text-sm font-medium text-slate-700 mb-1">Pickup Location</label>
        <input id="pickupInput" type="text" readonly placeholder="Click map or use current location" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" />
        <button id="useCurrentBtn" class="mt-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">Use Current Location</button>
      </div>
      <div class="relative">
        <label for="dropoffInput" class="block text-sm font-medium text-slate-700 mb-1">Dropoff Location</label>
        <input id="dropoffInput" type="text" placeholder="Type a place (min 3 characters)" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" />
        <div id="suggestBox" class="absolute left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-auto hidden z-20"></div>
        <button id="setDropoffBtn" class="mt-2 px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm">Set Dropoff</button>
      </div>
    </div>

    <!-- Vehicle cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6" role="radiogroup" aria-label="Vehicle type">
      <div id="bikeCard" class="cursor-pointer rounded-xl border border-slate-200 p-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow" tabindex="0" role="radio" aria-checked="false">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-orange-50 text-orange-600">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M5 16.5A3.5 3.5 0 1 0 8.5 20 3.5 3.5 0 0 0 5 16.5zm11 0A3.5 3.5 0 1 0 19.5 20 3.5 3.5 0 0 0 16 16.5zM10 6h4a1 1 0 0 1 .89.55l2.5 5A1 1 0 0 1 16.5 13H9.41l1.8 3.6a1 1 0 1 1-1.8.9l-2-4A1 1 0 0 1 8.2 12H15l-1.5-3H10a1 1 0 0 1 0-2z"/></svg>
          </div>
          <div class="flex-1">
            <div class="text-sm font-medium">Bike</div>
            <div id="bikePrice" class="text-orange-600 font-semibold">$0.00</div>
          </div>
          <input id="bikeRadio" type="radio" name="vehicle" value="bike" class="sr-only" aria-label="Select Bike" />
        </div>
      </div>

      <div id="carCard" class="cursor-pointer rounded-xl border border-slate-200 p-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow" tabindex="0" role="radio" aria-checked="false">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-orange-50 text-orange-600">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3 13l1.5-4.5A3 3 0 0 1 7.35 6H16.6a3 3 0 0 1 2.85 2.05L21 13v5a1 1 0 0 1-1 1h-1a2 2 0 0 1-2-2H7a2 2 0 0 1-2 2H4a1 1 0 0 1-1-1zm3.5 0h11l-1.33-4a1 1 0 0 0-.95-.67H7.78a1 1 0 0 0-.95.67z"/></svg>
          </div>
          <div class="flex-1">
            <div class="text-sm font-medium">Car</div>
            <div id="carPrice" class="text-orange-600 font-semibold">$0.00</div>
          </div>
          <input id="carRadio" type="radio" name="vehicle" value="car" class="sr-only" aria-label="Select Car" />
        </div>
      </div>

      <div id="autoCard" class="cursor-pointer rounded-xl border border-slate-200 p-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow" tabindex="0" role="radio" aria-checked="false">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-lg bg-orange-50 text-orange-600">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M4 14a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v4a1 1 0 0 1-1 1h-1a2 2 0 0 1-2-2H8a2 2 0 0 1-2 2H5a1 1 0 0 1-1-1zm3-5a5 5 0 0 1 5-5h0a5 5 0 0 1 5 5z"/></svg>
          </div>
          <div class="flex-1">
            <div class="text-sm font-medium">Auto</div>
            <div id="autoPrice" class="text-orange-600 font-semibold">$0.00</div>
          </div>
          <input id="autoRadio" type="radio" name="vehicle" value="auto" class="sr-only" aria-label="Select Auto" />
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <button id="bookButton" class="w-full bg-orange-600 hover:bg-orange-700 text-white p-3 rounded-lg font-semibold shadow">Book Ride</button>
      <button id="openUpdatePanel" class="w-full bg-slate-700 hover:bg-slate-800 text-white p-3 rounded-lg font-semibold shadow disabled" disabled>Update Locations</button>
    </div>
    <p id="message" class="mt-4 text-center text-slate-700"></p>

    <!-- Update panel -->
    <section id="updatePanel" class="mt-8 hidden">
      <div class="rounded-xl border border-slate-200 p-4 shadow-sm">
        <h2 class="text-xl font-semibold mb-4">Update Locations for Ride <span id="rideIdText" class="text-orange-600"></span></h2>
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <button id="togglePickupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm">Select Pickup</button>
          <button id="toggleDropoffBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm">Select Dropoff</button>
          <span class="text-xs text-slate-500">Click on the map to set the selected point</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 text-sm">
          <p>Pickup: <span id="pickupUpdateLabel" class="font-semibold text-orange-600">-</span></p>
          <p>Dropoff: <span id="dropoffUpdateLabel" class="font-semibold text-orange-600">-</span></p>
        </div>
        <button id="updateButton" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white p-3 rounded-lg font-semibold shadow">Confirm Update</button>
        <p id="updateMsg" class="mt-3 text-center text-slate-700"></p>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script>
    // Config
    const GEOAPIFY_API_KEY = '9efd1d5a33794a978148be1526c83da6';
    const RIDE_BOOK_URL = '/api/rides/book';
    const RIDE_UPDATE_URL = '/api/rides/update-location';
    const RIDE_RECREATE_URL = '/api/rides/recreate-with-location';
    const USER_ID = 'user2';

    // State
    let map, pickupMarker, dropoffMarker, routingControl;
    let debounceTimer, selecting = 'pickup', currentRideId = null, suggestedDropoff = null;

    // Utilities
    const $ = (id) => document.getElementById(id);
    const setText = (id, text) => $(id).textContent = text;
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const enable = (el) => { el.classList.remove('disabled'); el.disabled = false; };
    const disable = (el) => { el.classList.add('disabled'); el.disabled = true; };

    const vehicleRates = () => ({ bike: 0.5, car: 1.0, auto: 0.7 });
    const pickSelectedVehicle = () => document.querySelector('input[name="vehicle"]:checked')?.value || null;

    function icon(url){ return L.icon({ iconUrl: url, iconSize: [32, 32] }); }
    const greenIcon = icon('https://maps.google.com/mapfiles/ms/icons/green-dot.png');
    const redIcon   = icon('https://maps.google.com/mapfiles/ms/icons/red-dot.png');

    function toLatLng(str){
      const m = String(str||'').trim().match(/^(-?\d+(?:\.\d+)?),(-?\d+(?:\.\d+)?)$/);
      if(!m) return null; const lat = parseFloat(m[1]); const lng = parseFloat(m[2]);
      if(Number.isNaN(lat) || Number.isNaN(lng)) return null; return L.latLng(lat, lng);
    }

    function updateCardSelection(){
      const selected = pickSelectedVehicle();
      document.querySelectorAll('#bikeCard,#carCard,#autoCard').forEach(el=>el.classList.remove('ring-2','ring-orange-500','bg-orange-50'));
      if(selected){
        const card = $(selected + 'Card');
        if(card){ card.classList.add('ring-2','ring-orange-500','bg-orange-50'); card.setAttribute('aria-checked','true'); }
      }
    }

    function updatePrices(distanceKm){
      const rates = vehicleRates();
      const d = isNaN(distanceKm) || distanceKm <= 0 ? 5.0 : distanceKm;
      setText('bikePrice', `$${(d * rates.bike).toFixed(2)}`);
      setText('carPrice', `$${(d * rates.car).toFixed(2)}`);
      setText('autoPrice', `$${(d * rates.auto).toFixed(2)}`);
      updateCardSelection();
    }

    async function reverseGeocode(lat, lng){
      const url = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${GEOAPIFY_API_KEY}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Reverse geocode failed');
      const data = await res.json();
      const f = data.features?.[0];
      return f?.properties?.formatted || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    async function updateAddress(type){
      const marker = type === 'pickup' ? pickupMarker : dropoffMarker;
      if(!marker) return;
      const { lat, lng } = marker.getLatLng();
      try{
        const addr = await reverseGeocode(lat, lng);
        if(type === 'pickup'){
          setText('pickupLabel', addr);
          $('pickupInput').value = addr;
          setText('pickupUpdateLabel', addr);
        } else {
          setText('dropoffLabel', addr);
          $('dropoffInput').value = addr;
          setText('dropoffUpdateLabel', addr);
        }
      }catch(_){ /* ignore */ }
    }

    function calculateRoute(){
      if(!pickupMarker || !dropoffMarker) return;
      if(routingControl){ map.removeControl(routingControl); routingControl = null; }
      const start = pickupMarker.getLatLng();
      const end = dropoffMarker.getLatLng();
      const adjEnd = { lat: end.lat, lng: end.lng };
      if (start.lat === end.lat && start.lng === end.lng) { adjEnd.lat += 0.001; }
      routingControl = L.Routing.control({
        waypoints: [ start, L.latLng(adjEnd.lat, adjEnd.lng) ],
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        lineOptions: { styles: [{ color: '#2563eb', weight: 5, opacity: 0.9 }] },
        show: false, addWaypoints: false, routeWhileDragging: false, draggableWaypoints: false,
        fitSelectedRoutes: true
      }).addTo(map);
      routingControl.on('routesfound', (e) => {
        const r = e.routes[0];
        const km = (r.summary.totalDistance / 1000);
        const min = (r.summary.totalTime / 60);
        setText('distance', km.toFixed(2));
        setText('duration', min.toFixed(1));
        updatePrices(km);
      }).on('routingerror', () => {
        setText('distance', 'N/A');
        setText('duration', '10.0');
        updatePrices(5.0);
        if(routingControl){ map.removeControl(routingControl); routingControl = null; }
      });
    }

    function debounced(fn, wait){
      return function(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(fn, wait); };
    }

    async function searchLocation(){
      const q = $('dropoffInput').value.trim();
      const suggestBox = $('suggestBox');
      if(q.length < 3){ hide(suggestBox); suggestBox.innerHTML = ''; return; }
      const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(q)}&limit=6&apiKey=${GEOAPIFY_API_KEY}`;
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Search failed');
        const data = await res.json();
        const items = (data.features||[]).map(f=>({ label: f.properties?.formatted, lat: f.properties?.lat, lng: f.properties?.lon })).filter(x=>x.label && x.lat && x.lng);
        if(!items.length){ hide(suggestBox); suggestBox.innerHTML=''; return; }
        suggestBox.innerHTML = items.map((it,i)=>`<button data-i="${i}" class="w-full text-left px-3 py-2 hover:bg-slate-50">${it.label}</button>`).join('');
        show(suggestBox);
        Array.from(suggestBox.querySelectorAll('button[data-i]')).forEach(btn => {
          btn.addEventListener('click', () => {
            const i = parseInt(btn.getAttribute('data-i'), 10);
            const it = items[i];
            if(dropoffMarker) map.removeLayer(dropoffMarker);
            dropoffMarker = L.marker([it.lat, it.lng], { icon: redIcon }).addTo(map).bindPopup(it.label).openPopup();
            $('dropoffInput').value = it.label;
            setText('dropoffLabel', it.label);
            setText('dropoffUpdateLabel', it.label);
            suggestedDropoff = L.latLng(it.lat, it.lng);
            map.setView([it.lat, it.lng], 13);
            hide(suggestBox); suggestBox.innerHTML='';
            if(pickupMarker) calculateRoute();
          });
        });
      }catch(_){ hide(suggestBox); suggestBox.innerHTML=''; }
    }

    async function bookRide(){
      const vehicleType = pickSelectedVehicle();
      if(!vehicleType){ alert('Please select a vehicle type.'); return; }
      if(!pickupMarker || !dropoffMarker){ alert('Please set both pickup and dropoff locations.'); return; }
      const bookBtn = $('bookButton');
      const msg = $('message');
      disable(bookBtn);
      msg.textContent = 'Booking your ride...';
      msg.className = 'mt-4 text-center text-slate-500';

      const pickupAddr = $('pickupInput').value.trim();
      const dropoffAddr = $('dropoffInput').value.trim();
      const fare = parseFloat($(vehicleType + 'Price').textContent.replace('$','')) || 0;

      try{
        const response = await fetch(RIDE_BOOK_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: USER_ID, vehicleType, pickupLocation: pickupAddr, dropoffLocation: dropoffAddr, fare })
        });
        if(!response.ok){ const t = await response.text(); throw new Error(`${response.status} ${t||''}`); }
        const data = await response.json();
        currentRideId = data.id || data.rideId || null;
        msg.textContent = currentRideId ? `Ride booked! ID: ${currentRideId}` : 'Ride booked successfully.';
        msg.className = 'mt-4 text-center text-emerald-600';
        // Redirect to ride-status page to await driver acceptance
        if(currentRideId){
          const url = `/ride-status.html?rideId=${encodeURIComponent(currentRideId)}&pickup=${encodeURIComponent(pickupAddr)}&dropoff=${encodeURIComponent(dropoffAddr)}&vehicleType=${encodeURIComponent(vehicleType)}&amount=${encodeURIComponent(fare.toFixed(2))}`;
          setTimeout(() => { window.location.href = url; }, 800);
          return;
        }
        // Fallback: enable update panel if no ID present
        const openUpdateBtn = $('openUpdatePanel');
        if(currentRideId){ enable(openUpdateBtn); $('rideIdText').textContent = `#${currentRideId}`; show($('updatePanel')); }
      }catch(e){
        msg.textContent = `Booking failed: ${e.message}`;
        msg.className = 'mt-4 text-center text-red-600';
      } finally { enable(bookBtn); }
    }

    async function updateRideLocations(){
      if(!currentRideId){ $('updateMsg').textContent = 'Ride ID not available.'; return; }
      if(!pickupMarker || !dropoffMarker){ $('updateMsg').textContent = 'Please select both pickup and dropoff.'; return; }
      const pu = pickupMarker.getLatLng();
      const do_ = dropoffMarker.getLatLng();
      const payload = { id: String(currentRideId), pickupLocation: `${pu.lat},${pu.lng}`, dropoffLocation: `${do_.lat},${do_.lng}` };
      const updateBtn = $('updateButton');
      const updateMsgEl = $('updateMsg');
      disable(updateBtn); updateMsgEl.textContent = 'Updating locations...'; updateMsgEl.className = 'mt-3 text-center text-slate-500';
      try{
        // Create a new ride and cancel the old one
        const resp = await fetch(RIDE_RECREATE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if(!resp.ok){ const t = await resp.text(); throw new Error(t || 'Failed to recreate ride'); }
        const data = await resp.json();
        const newId = data.id || data.rideId;
        updateMsgEl.textContent = `New request created. Ride ID: ${newId}. Distance: ${Number(data.distance||0).toFixed(2)} km, Duration: ${Number(data.duration||0).toFixed(1)} mins`;
        updateMsgEl.className = 'mt-3 text-center text-emerald-600';
        // Redirect to the new ride's status so driver can accept
        setTimeout(()=>{ window.location.href = `/ride-status.html?rideId=${encodeURIComponent(newId)}`; }, 800);
      }catch(e){
        updateMsgEl.textContent = `Error updating locations: ${e.message}`;
        updateMsgEl.className = 'mt-3 text-center text-red-600';
      } finally { enable(updateBtn); }
    }

    function initMap(){
      map = L.map('map').setView([6.9271, 79.8612], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

      map.on('click', async (e) => {
        const { lat, lng } = e.latlng;
        if(selecting === 'pickup'){
          if (pickupMarker) map.removeLayer(pickupMarker);
          pickupMarker = L.marker([lat, lng], { icon: greenIcon }).addTo(map).bindPopup('Pickup').openPopup();
          await updateAddress('pickup');
        } else {
          if (dropoffMarker) map.removeLayer(dropoffMarker);
          dropoffMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map).bindPopup('Dropoff').openPopup();
          await updateAddress('dropoff');
        }
        if (pickupMarker && dropoffMarker) calculateRoute();
      });

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          const { latitude, longitude } = pos.coords;
          if(!pickupMarker){
            pickupMarker = L.marker([latitude, longitude], { icon: greenIcon }).addTo(map).bindPopup('Your Location').openPopup();
            setText('pickupLabel', 'Locating address...');
            $('pickupInput').value = '';
            await updateAddress('pickup');
            map.setView([latitude, longitude], 13);
          }
        }, ()=>{}, { enableHighAccuracy: true, timeout: 8000 });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();

      // Vehicle selection behaviour
      [['bikeCard','bikeRadio'], ['carCard','carRadio'], ['autoCard','autoRadio']].forEach(([cardId, radioId])=>{
        const card = $(cardId);
        card.addEventListener('click', ()=>{
          const radio = $(radioId); if(radio){ radio.checked = true; }
          updateCardSelection();
          if (pickupMarker && dropoffMarker) calculateRoute();
        });
        card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); card.click(); }});
      });

      const onDropoffInput = debounced(searchLocation, 400);
      $('dropoffInput').addEventListener('input', onDropoffInput);

      const updatePanelEl = $('updatePanel');
      $('setDropoffBtn').addEventListener('click', () => {
        if(!suggestedDropoff){ alert('Please search and select a dropoff first.'); return; }
        if(dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = L.marker(suggestedDropoff, { icon: redIcon }).addTo(map).bindPopup('Dropoff').openPopup();
        updateAddress('dropoff');
        if(pickupMarker) calculateRoute();
      });

      $('useCurrentBtn').addEventListener('click', async () => {
        if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
        const btn = $('useCurrentBtn'); disable(btn); const prev = btn.textContent; btn.textContent = 'Locating...';
        navigator.geolocation.getCurrentPosition(async (pos)=>{
          const { latitude, longitude } = pos.coords;
          if(pickupMarker) map.removeLayer(pickupMarker);
          pickupMarker = L.marker([latitude, longitude], { icon: greenIcon }).addTo(map).bindPopup('Pickup').openPopup();
          map.setView([latitude, longitude], 13);
          await updateAddress('pickup');
          btn.textContent = prev; enable(btn);
        }, (err)=>{ alert('Unable to get current location: ' + (err?.message||'Unknown')); btn.textContent = prev; enable(btn); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 10000 });
      });

      $('bookButton').addEventListener('click', bookRide);
      $('openUpdatePanel').addEventListener('click', ()=>{ show(updatePanelEl); });
      $('updateButton').addEventListener('click', updateRideLocations);
      $('togglePickupBtn').addEventListener('click', ()=>{ selecting = 'pickup'; });
      $('toggleDropoffBtn').addEventListener('click', ()=>{ selecting = 'dropoff'; });

      // URL params support
      const params = new URLSearchParams(window.location.search);
      const rid = params.get('rideId');
      const pickupParam = params.get('pickup');
      const dropoffParam = params.get('dropoff');
      if(rid){
        currentRideId = rid; $('rideIdText').textContent = `#${rid}`;
        enable($('openUpdatePanel'));
        show(updatePanelEl);
        const pu = toLatLng(pickupParam);
        const do_ = toLatLng(dropoffParam);
        if(pu){ if(pickupMarker) map.removeLayer(pickupMarker); pickupMarker = L.marker([pu.lat, pu.lng], { icon: greenIcon }).addTo(map).bindPopup('Pickup'); updateAddress('pickup'); }
        if(do_){ if(dropoffMarker) map.removeLayer(dropoffMarker); dropoffMarker = L.marker([do_.lat, do_.lng], { icon: redIcon }).addTo(map).bindPopup('Dropoff'); updateAddress('dropoff'); }
        if(pickupMarker && dropoffMarker){ map.fitBounds([pickupMarker.getLatLng(), dropoffMarker.getLatLng()]); calculateRoute(); }
      }

      // Initial price display
      updatePrices(5.0);
    });
  </script>
</body>
</html>
