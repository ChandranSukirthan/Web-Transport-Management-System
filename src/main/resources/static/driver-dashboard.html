<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Driver Console — QuickMove</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="flex">
  <!-- Left Sidebar: Driver Profile -->
  <div class="w-80 bg-white shadow-xl h-screen sticky top-0 p-6 border-r border-gray-200">
    <div class="text-center mb-8">
      <div class="w-24 h-24 bg-orange-500 text-white text-4xl font-bold rounded-full mx-auto flex items-center justify-center">
        <span id="driverInitials">D</span>
      </div>
      <h2 id="driverName" class="text-xl font-bold mt-4 text-gray-800">Loading...</h2>
      <p id="driverEmail" class="text-sm text-gray-500">driver@quickmove.com</p>
    </div>

    <div class="space-y-5 text-sm">
      <div class="flex justify-between">
        <span class="text-gray-600">Status</span>
        <span id="driverStatus" class="font-semibold text-orange-600">OFFLINE</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Vehicle</span>
        <span id="driverVehicle" class="font-medium">—</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Plate No.</span>
        <span id="driverPlate" class="font-medium uppercase">—</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Total Earnings</span>
        <span id="driverEarnings" class="font-bold text-green-600">$0.00</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Rides Completed</span>
        <span id="driverRidesCount" class="font-medium">0</span>
      </div>
    </div>

    <div class="mt-10">
      <button id="logoutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg transition">
        Logout
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 p-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold text-orange-600 mb-2">Driver Console</h1>
      <p id="status" class="text-lg text-gray-600 mb-8">Connecting to server...</p>

      <div id="requests" class="space-y-5"></div>

      <!-- No active requests -->
      <div id="noRequests" class="text-center py-12 text-gray-500 hidden">
        <p class="text-xl">No ride requests at the moment</p>
        <p class="text-sm mt-2">You're all caught up! New requests will appear here instantly.</p>
      </div>
    </div>
  </div>
</div>

<!-- Template for Ride Request Card -->
<template id="requestTpl">
  <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl transition">
    <div class="flex justify-between items-start">
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-3">
          <span class="text-sm font-semibold text-gray-500">Ride ID:</span>
          <span data-field="id" class="font-mono text-orange-600"></span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div><strong>Pickup:</strong> <span data-field="pickup" class="text-gray-700"></span></div>
          <div><strong>Dropoff:</strong> <span data-field="dropoff" class="text-gray-700"></span></div>
          <div><strong>Distance:</strong> <span data-field="distance"></span> km</div>
          <div><strong>ETA:</strong> <span data-field="duration"></span> mins</div>
          <div class="text-lg font-bold text-green-600"><strong>Fare:</strong> $<span data-field="fare"></span></div>
        </div>
      </div>
      <div class="ml-6">
        <button class="acceptBtn bg-orange-500 hover:bg-orange-600 text-white font-bold px-8 py-3 rounded-lg shadow-md transition transform hover:scale-105">
          Accept Ride
        </button>
      </div>
    </div>
  </div>
</template>

<script>
  const driverUserId = localStorage.getItem('userId') || '1'; // Set after login
  let driverId = null;
  let stompClient = null;

  // DOM Elements
  const statusEl = document.getElementById('status');
  const requestsEl = document.getElementById('requests');
  const noRequestsEl = document.getElementById('noRequests');
  const tpl = document.getElementById('requestTpl');

  // Profile Elements
  const driverName = document.getElementById('driverName');
  const driverEmail = document.getElementById('driverEmail');
  const driverInitials = document.getElementById('driverInitials');
  const driverStatus = document.getElementById('driverStatus');
  const driverVehicle = document.getElementById('driverVehicle');
  const driverPlate = document.getElementById('driverPlate');
  const driverEarnings = document.getElementById('driverEarnings');
  const driverRidesCount = document.getElementById('driverRidesCount');

  function setStatus(text, color = 'text-gray-600') {
    statusEl.textContent = text;
    statusEl.className = `text-lg ${color} mb-8`;
  }

  async function loadDriverProfile() {
    try {
      const res = await fetch(`/api/drivers/user/${driverUserId}`);
      if (!res.ok) throw new Error('Not found');
      const driver = await res.json();

      driverId = driver.id;
      driverName.textContent = driver.name || 'Driver';
      driverEmail.textContent = localStorage.getItem('userEmail') || 'driver@quickmove.com';
      driverInitials.textContent = (driver.name || 'D').split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2);
      driverStatus.textContent = driver.status || 'OFFLINE';
      driverStatus.className = driver.status === 'AVAILABLE' ? 'font-bold text-green-600' : 'font-bold text-orange-600';
      driverVehicle.textContent = driver.vehicleType || '—';
      driverPlate.textContent = driver.numberPlate || '—';

      // Load earnings & ride count
      const earningsRes = await fetch(`/api/drivers/${driver.id}/earnings`);
      const ridesRes = await fetch(`/api/drivers/${driver.id}/rides`);
      if (earningsRes.ok) driverEarnings.textContent = '$' + (await earningsRes.json()).toFixed(2);
      if (ridesRes.ok) {
        const rides = await ridesRes.json();
        driverRidesCount.textContent = rides.filter(r => r.status === 'COMPLETED').length;
      }
    } catch (e) {
      setStatus('Driver profile load failed', 'text-red-600');
    }
  }

  function connectWebSocket() {
    setStatus('Connecting to server...');
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
      setStatus('Online — Waiting for ride requests', 'text-green-600');
      stompClient.subscribe('/topic/rideRequests', (msg) => {
        if (msg.body) {
          const ride = JSON.parse(msg.body);
          if (ride.status === 'PENDING' && !ride.driverId) {
            addRideCard(ride);
            noRequestsEl.classList.add('hidden');
          }
        }
      });
    }, () => setStatus('Connection lost. Reconnecting...', 'text-red-600'));
  }

  function addRideCard(ride) {
    if (document.getElementById('ride-' + ride.id)) return;
    const card = tpl.content.firstElementChild.cloneNode(true);
    card.id = 'ride-' + ride.id;
    card.querySelector('[data-field="id"]').textContent = ride.id;
    card.querySelector('[data-field="pickup"]').textContent = ride.pickupLocation || '—';
    card.querySelector('[data-field="dropoff"]').textContent = ride.dropoffLocation || '—';
    card.querySelector('[data-field="distance"]').textContent = (ride.distance || 0).toFixed(1);
    card.querySelector('[data-field="duration"]').textContent = Math.round(ride.duration || 0);
    card.querySelector('[data-field="fare"]').textContent = (ride.fare || 0).toFixed(2);

    card.querySelector('.acceptBtn').onclick = () => acceptRide(ride.id);
    requestsEl.prepend(card);
  }

  async function acceptRide(rideId) {
    if (!driverId) return;
    setStatus('Accepting ride...');
    const res = await fetch(`/api/drivers/${driverId}/rides/${rideId}/accept`, { method: 'POST' });
    if (res.ok) {
      document.getElementById('ride-' + rideId)?.remove();
      if (requestsEl.children.length === 0) noRequestsEl.classList.remove('hidden');
      setStatus('Ride accepted! Redirecting...', 'text-green-600');
      setTimeout(() => {
        window.location.href = `/driver-tracking.html?rideId=${rideId}&driverId=${driverId}`;
      }, 1000);
    } else {
      setStatus('Failed to accept ride', 'text-red-600');
    }
  }

  document.getElementById('logoutBtn').onclick = () => {
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = '/login.html';
  };

  // Init
  window.addEventListener('load', () => {
    loadDriverProfile();
    connectWebSocket();
  });
</script>
</body>
</html>