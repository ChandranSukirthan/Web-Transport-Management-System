<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ride Status - QuickMove</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>@import url("https://rsms.me/inter/inter.css");</style>
  <script>
    function qp(name, dflt = ''){ const u = new URL(window.location.href); return u.searchParams.get(name) ?? dflt; }
  </script>
</head>
<body class="bg-white text-slate-800">
  <header class="border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/ride-booking.html" class="text-xl font-bold text-orange-600">QuickMove</a>
      <a href="/ride-booking.html" class="text-sm font-medium text-orange-600 hover:text-orange-700">Book a ride</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="mb-5">
      <h1 class="text-2xl md:text-3xl font-bold text-orange-600">Ride status</h1>
      <div class="text-slate-500">We're looking for a driver. This page will update automatically.</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <div class="lg:col-span-2 space-y-4">
        <section class="rounded-xl border border-slate-200 shadow-sm">
          <div class="p-4">
            <h2 class="text-lg font-semibold mb-3">Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <div class="text-slate-500">Ride ID</div>
                <div id="rsRideId" class="font-semibold"></div>
              </div>
              <div>
                <div class="text-slate-500">Vehicle</div>
                <div id="rsVehicle" class="font-semibold"></div>
              </div>
              <div class="md:col-span-2">
                <div class="text-slate-500">Pickup</div>
                <div id="rsPickup" class="break-words"></div>
              </div>
              <div class="md:col-span-2">
                <div class="text-slate-500">Dropoff</div>
                <div id="rsDropoff" class="break-words"></div>
              </div>
              <div>
                <div class="text-slate-500">Estimate</div>
                <div id="rsAmount" class="font-semibold text-emerald-600"></div>
              </div>
              <div>
                <div class="text-slate-500">Status</div>
                <div id="rsStatus" class="font-semibold">Pending</div>
              </div>
            </div>
          </div>
        </section>

        <section class="rounded-xl border border-slate-200 shadow-sm" id="confirmBox" style="display:none">
          <div class="p-4">
            <h2 class="text-lg font-semibold mb-2">Confirm your ride</h2>
            <p class="text-slate-600 text-sm mb-3">A driver has accepted your request. Please confirm to start tracking, or decline to cancel.</p>
            <div class="flex gap-3">
              <button id="acceptBtn" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white">Accept</button>
              <button id="declineBtn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Decline</button>
            </div>
          </div>
        </section>

        <section class="rounded-xl border border-slate-200 shadow-sm">
          <div class="p-4">
            <h2 class="text-lg font-semibold mb-2">What happens next?</h2>
            <ul class="text-slate-600 text-sm list-disc pl-5">
              <li>We notify nearby drivers.</li>
              <li>Once a driver accepts, confirm to start live tracking.</li>
              <li>Declining cancels the ride.</li>
            </ul>
          </div>
        </section>
      </div>

      <aside class="space-y-4">
        <section class="rounded-xl border border-slate-200 shadow-sm">
          <div class="p-4">
            <h2 class="text-lg font-semibold mb-3">Driver</h2>
            <div id="rsDriver" class="text-slate-600">Not assigned yet</div>
          </div>
        </section>
        <section class="rounded-xl border border-slate-200 shadow-sm">
          <div class="p-4 space-y-2">
            <h2 class="text-lg font-semibold">Actions</h2>
            <button id="cancelBtn" class="w-full px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Cancel ride</button>
            <button id="editLocationsBtn" class="w-full px-4 py-2 rounded bg-slate-700 hover:bg-slate-800 text-white">Update locations</button>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script>
    (function(){
      const rideId = qp('rideId');
      const pickup = decodeURIComponent(qp('pickup'));
      const dropoff = decodeURIComponent(qp('dropoff'));
      const vehicleType = qp('vehicleType');
      const amount = qp('amount');

      const RIDE_STATUS_API = `/api/rides/${encodeURIComponent(rideId)}`;
      const RIDE_CANCEL_API = `/api/rides/cancel/${encodeURIComponent(rideId)}`; // DELETE matches backend
      const TS_SUMMARY_API = `/api/tracking-sessions/ride/${encodeURIComponent(rideId)}/active-summary`;
      const TS_CREATE_API = `/api/tracking-sessions`;
      const TS_RIDER_ACCEPT_API = `/api/tracking-sessions/ride/${encodeURIComponent(rideId)}/rider-accept`;
      const WS_URL = '/ws';

      // Fill summary
      document.getElementById('rsRideId').textContent = rideId || '-';
      document.getElementById('rsVehicle').textContent = vehicleType || '-';
      document.getElementById('rsPickup').textContent = pickup || '-';
      document.getElementById('rsDropoff').textContent = dropoff || '-';
      document.getElementById('rsAmount').textContent = amount ? amount : '-';

      const statusEl = document.getElementById('rsStatus');
      const driverEl = document.getElementById('rsDriver');
      const confirmBox = document.getElementById('confirmBox');
      const acceptBtn = document.getElementById('acceptBtn');
      const declineBtn = document.getElementById('declineBtn');

      let latestRide = null;
      let sessionEnsured = false;

      function showConfirm(show){ confirmBox.style.display = show ? '' : 'none'; }
      function goCancelled(){ window.location.href = '/ride-cancelled.html?rideId=' + encodeURIComponent(rideId); }
      function toTracking(){ const url = `/rider-tracking.html?rideId=${encodeURIComponent(rideId)}`; window.location.href = url; }
      function toBookingUpdate(){
        const url = `/ride-booking.html?rideId=${encodeURIComponent(rideId)}${pickup? `&pickup=${encodeURIComponent(pickup)}`:''}${dropoff? `&dropoff=${encodeURIComponent(dropoff)}`:''}`;
        window.location.href = url;
      }

      async function fetchJSON(url, opts){ const r = await fetch(url, opts); if(!r.ok) throw new Error('HTTP '+r.status+': '+await r.text()); return r.json(); }

      async function ensureSession(){
        if(sessionEnsured) return;
        try{
          const ride = latestRide || await fetchJSON(RIDE_STATUS_API);
          latestRide = ride;
          const driverUserId = ride && ride.driverId ? ride.driverId : null;
          if(!driverUserId){ return; }
          const driver = await fetchJSON(`/api/drivers/user/${encodeURIComponent(driverUserId)}`);
          if(!driver || !driver.id){ return; }
          try { await fetchJSON(TS_CREATE_API, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ rideId: Number(rideId), driverId: Number(driver.id), riderUserId: ride.userId, createdBy: 'rider' }) }); } catch(_) {}
          sessionEnsured = true;
        }catch(_){ }
      }

      async function markRiderAccepted(){
        try{
          const riderId = latestRide?.userId ? `?riderUserId=${encodeURIComponent(latestRide.userId)}` : '';
          await fetchJSON(TS_RIDER_ACCEPT_API + riderId, { method: 'POST' });
          toTracking();
        }catch(e){ alert('Unable to confirm ride yet. Please try again.'); }
      }

      async function fetchSummary(){
        try{
          const s = await fetchJSON(TS_SUMMARY_API);
          const st = (latestRide?.status || '').toUpperCase();
          const accepted = (st === 'ACCEPTED' || st === 'ASSIGNED');
          if(st === 'CANCELLED'){ goCancelled(); return; }
          // Show confirm as soon as driver accepted via ride status, even if session doesn't reflect driverAccepted yet
          if(accepted){
            if(!(s && s.riderAccepted)) { showConfirm(true); } else { showConfirm(false); }
            // Redirect if rider has accepted
            if(s && s.riderAccepted){ toTracking(); return; }
            return; // wait for rider action
          }
          if(s && s.hasActive){
            if(s.driverAccepted && !s.riderAccepted){ showConfirm(true); return; }
            showConfirm(false);
            if(s.riderAccepted && s.driverAccepted){ toTracking(); return; }
          }
        }catch(_){ /* silent */ }
      }

      async function fetchStatus(){
        try {
          const data = await fetchJSON(RIDE_STATUS_API);
          latestRide = data;
          const st = (data.status || 'PENDING').toUpperCase();
          statusEl.textContent = st;
          // Refresh summary fields from backend so updates show after redirect
          if (data.pickupLocation) { document.getElementById('rsPickup').textContent = data.pickupLocation; }
          if (data.dropoffLocation) { document.getElementById('rsDropoff').textContent = data.dropoffLocation; }
          if (data.vehicleType) { document.getElementById('rsVehicle').textContent = data.vehicleType; }
          if (typeof data.fare === 'number') { document.getElementById('rsAmount').textContent = data.fare.toFixed(2); }
          if(data.driver){ driverEl.textContent = `${data.driver.name} • ${data.driver.numberPlate}`; }
          if(st === 'ACCEPTED' || st === 'ASSIGNED'){
            ensureSession();
            showConfirm(true);
          }
          if(st === 'CANCELLED'){
            goCancelled();
          }
        } catch(e) { /* retry via polling */ }
      }

      // WebSocket updates
      let stompClient = null;
      function connectWs(){
        try {
          const socket = new SockJS(WS_URL);
          stompClient = Stomp.over(socket);
          stompClient.connect({}, () => {
            const topics = [ `/topic/rides/${rideId}`, `/topic/rideUpdates/${rideId}` ];
            topics.forEach(topic => {
              try{
                stompClient.subscribe(topic, (msg)=>{
                  try {
                    const evt = JSON.parse(msg.body);
                    if(String(evt.id||evt.rideId||'') !== String(rideId)) return;
                    const st = (evt.status||'').toUpperCase();
                    if(st) statusEl.textContent = st;
                    if(evt.driver){ driverEl.textContent = `${evt.driver.name} • ${evt.driver.numberPlate}`; }
                    if(st === 'ACCEPTED' || st === 'ASSIGNED'){ ensureSession(); }
                    if(st === 'CANCELLED'){ goCancelled(); }
                  } catch(_) {}
                });
              }catch(_){ }
            });
          }, () => { setTimeout(connectWs, 3000); });
        } catch(_) { }
      }

      // Polling
      const poll1 = setInterval(fetchStatus, 4000);
      const poll2 = setInterval(fetchSummary, 3000);
      window.addEventListener('unload', ()=>{ try{ clearInterval(poll1); clearInterval(poll2); if(stompClient && stompClient.connected) stompClient.disconnect(); }catch(_){} });

      // Buttons
      document.getElementById('cancelBtn').addEventListener('click', async ()=>{
        if(!rideId) return;
        try{
          const r = await fetch(RIDE_CANCEL_API, { method: 'DELETE' });
          if(r.ok){ window.location.href = '/ride-cancelled.html?rideId=' + encodeURIComponent(rideId); }
          else { alert('Unable to cancel ride.'); }
        }catch(_){ alert('Network error while cancelling.'); }
      });
      acceptBtn.addEventListener('click', markRiderAccepted);
      declineBtn.addEventListener('click', async ()=>{
        try{ const r = await fetch(RIDE_CANCEL_API, { method: 'DELETE' }); }catch(_){}
        goCancelled();
      });
      document.getElementById('editLocationsBtn').addEventListener('click', toBookingUpdate);

      // init
      fetchStatus();
      fetchSummary();
      connectWs();
    })();
  </script>
</body>
</html>
